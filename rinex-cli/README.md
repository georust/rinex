RINEX-cli 
=========

Command line tool to parse, analyze and manage RINEX files.  

[![crates.io](https://img.shields.io/crates/v/rinex-cli.svg)](https://crates.io/crates/rinex-cli)
[![License](https://img.shields.io/badge/license-Apache%202.0-blue?style=flat-square)](https://github.com/gwbres/rinex/blob/main/LICENSE-APACHE)
[![License](https://img.shields.io/badge/license-MIT-blue?style=flat-square)](https://github.com/gwbres/rinex/blob/main/LICENSE-MIT) 

The first purpose of this tool is to expose the [library](https://github.com/gwbres/rinex/rinex) 
in a high level and easy to use fashion.  
The application will be able to parse all RINEX formats supported by the library, refer to the front page to understand which RINEX format is currently supported.

The application knows a few `teqc` operations, refer to the
[dedicated paragraph](https://github.com/gwbres/rinex/blob/main/rinex-cli/README.md#teqc-operations)
down below.

This tool will eventually be able to perform most common RINEX 
[post-processing](https://github.com/gwbres/rinex/blob/main/rinex-cli/README.md#post-processing).

## File naming conventions

File names are disregarded by these tools, you can analyze
& parse files that do not follow naming conventions.

When producing data, this tool will eventually help the user to generate RINEX that follows
naming conventions, but that is currently under development.

### Compressed data

CRINEX (V1 and V3) are natively supported.

This tool supports gzip compressed files, as long as their name is terminated
by `.gz`.

## Plotting and Data visualization

A data visualization method is currently under development.
It is currently available only for Observation Data.
Refer to the 
[plot section](https://github.com/gwbres/rinex/blob/main/rinex-cli/README.md#data-visualization)

## `teqc` operations

`teqc` is a well known application to process RINEX.  

Unlike `teqc`, this application is not capable of processing Binary RINEX ("BINEX") and 
proprietary formats in general.

Here is the list of operations that this tool is capable of performing,
that usually people use `teqc` almost exclusively to perform, to this day

- [merge](https://github.com/gwbres/rinex/blob/main/rinex-cli/README.md#merge)
several RINEX together into a single file.

- [decimate](https://github.com/gwbres/rinex/blob/main/rinex-cli/README.md#decimate)
RINEX record to reduce the quantity of data to analyze

- [split](https://github.com/gwbres/rinex/blob/main/rinex-cli/README.md#split)
given file(s) into two

- [ascii-plot](https://github.com/gwbres/rinex/blob/main/rinex-cli/README.md#ascii-plot)
to print a very descriptive tiny plot in the terminal,
as contained in reports generated by `teqc`

## Getting started

Install dependencies:

```shell
apt-get install libfontconfig1-dev
```

Always compile Rust code with the `--release` flag,
so the implementation gets optimized 
(see our [benchmark results](https://github.com/gwbres/rinex#performances)
that emphasize its impact):

```shell
cargo build --release
./target/release/rinex-cli -h
```

In the following "rinex-cli" means "target/release/rinex-cli" previously compiled

Arguments order does not matter for the application.   

`fp` is the only mandatory argument, other flags are optional.

Major arguments have an abbreviation:

```bash
rinex-cli --fp /tmp/amel010.21g
rinex-cli -f /tmp/amel010.21g
```

Some arguments support an array of values to be given.

If one amongst all given values is faulty (not recognized) it is just dropped,
and we use all other valid values: the application does not crash.

To describe list of values, for example when describing retain-filter options,
we use a CSV format:

```bash
rinex-cli \
     -f test_resources/OBS/V2/rovn0010.21o \
        --retain-sv G01,G02
```

## Tool philosophy

Invoke the tool against one or several files.  
Several files might be required based on the operation to perform.  
It is not recommended to combine special ops like "merge" or "diff",
to other ops.
All flags are optionnal and can be combined, expect for some special operations.  

If you request some operation, usually to inspect internal data (like `epoch` or `sv`),
the tool will not expose the record but will restrict to the requested information.

For example, this command line will expose identified epochs and vehicules

```bash
rinex-cli -f test_resources/OBS/V2/KOSG0010.95O --epochs --sv
``` 

If no specific data or fields are requested to be displayed, then we expose the record

```bash
rinex-cli -f test_resources/OBS/V2/KOSG0010.95O
``` 

Because RINEX files are huge and complex, we developped some filtering operations
to reduce data quantity and focus on data of interest.

`retain-` operations will only retain data of interest.
`filter-` operations will filter non interesting data.

For example this command will only retain data from specific vehicules

```bash
rinex-cli 
     -f test_resources/OBS/V2/rovn0010.21o \
        --retain-sv R03,G10
``` 

Filter operations can be stacked

```bash
rinex-cli --pretty -f test_resources/OBS/V2/rovn0010.21o \
    --decim-interval 00:05:00 \
        --retain-sv G10
```

When specific operations are combined to filter operations,
we perform them on the filtered data content.
For instance, here requesting identified epochs in the decimated record
versus default record content:

```bash
rinex-cli --pretty -f test_resources/OBS/V2/rovn0010.21o --epochs
rinex-cli --pretty -f test_resources/OBS/V2/rovn0010.21o \
    --decim-interval 01:30:00 --epochs
```

## Output format

This tool uses JSON format to expose data, which makes it easy
to import into other tools. The `--pretty` argument is available
and can be combined to all existing flags, to indent the exposed data,
and make it easier to read

```bash
rinex-cli --pretty -f /tmp/amel010.21g \
      --epoch --sv-filter R01,G01 

rinex-cli -f /tmp/amel010.21g \
      --decimate-interval 00:05:00 \
            --sv-filter G01 --pretty
``` 

## Record resampling 

To reduce the record size, we use decimation

- either by an integer ratio
- or by a minimum epoch interval ("sampling interval") to follow

It is also possible to apply a "time window" to the RINEX
record, all epochs that do not lie within the a < e(k) < b predicate
will get filtered out.

Example: decimate record by 2.
From original epochs a,b,c,d, we're only left with a,c
```bash
rinex-cli -f test_resources/OBS/V2/zegv0010.21o \
    --resample-ratio 2
```

Example: decimate to match a minimal sampling period.
When describing a sampling period (chrono::Duration),
we expect an %HH:%MM:%SS format, which can exceed 24 hours
```bash
# print original epochs
rinex-cli -f test_resources/NAV/V4/KMS300DNK_R_20221591000_01H_MN.rnx.gz \
    --epochs
# Fit minimal sampling period to 1 day
rinex-cli -f test_resources/NAV/V4/KMS300DNK_R_20221591000_01H_MN.rnx.gz \
    --epochs \
        --resample-interval 24:00:00
```

It is also possible to restring epochs to a given interval (or "time window").
When describing a time window, we can either describe a Date interval (%Y-%m-%d)
or a DateTime interval (%Y-%m%d %HH:%MM:%SS).
Since this descriptor involves whitespaces, it must be quoted

```bash
# print original epochs
rinex-cli -f test_resources/NAV/V4/KMS300DNK_R_20221591000_01H_MN.rnx.gz \
    --epochs
# restrict to last day contained in record
rinex-cli -f test_resources/NAV/V4/KMS300DNK_R_20221591000_01H_MN.rnx.gz \
    --epochs \
        --time-window "2022-06-09 2022-06-11" 
 
# grab some of the last epochs of first day and entire final days
rinex-cli -f test_resources/NAV/V4/KMS300DNK_R_20221591000_01H_MN.rnx.gz \
    --epochs \
        --time-window "2022-06-08 11:00:00 2022-06-11 12:00:00" 
```

## Signal condition filters

Observation data might have an "LLI" flag attached to them.
It is possible to apply an And() mask on this field. In this case,
all epochs that did not come with an LLI flag get also dropped out.

In this example, we focus on epochs where a `Loss of Lock` event happened

```shell
rinex-cli --pretty --lli-mask 1 --sv R01 \ 
          -f test_resources/OBS/V2/zegv0010.21o
```

SSI field is another data field that might come with an observation
and it gives the estimated receiver power / SNR at the sampling instant.

It is possible to filter data on minimum signal strength, which
is equivalent to a data "quality" filter

With the following command, we only retain data with SSI >= 5
that means at least 30 dB SNR. 

```shell
rinex-cli --pretty -f test_resources/OBS/V2/zegv0010.21o \
        --ssi-filter 5 --sv-filter R01
```

## Observables

It is possible to focus physics or data of interest
by using the retain-obs filter, on Observation RINEX:

```bash
# list encountered "observables"
rinex-cli -f test_resources/OBS/V3/CBW100NLD_R_20210010000_01D_MN.rnx --obs

# extract raw phase data and pseudo range only
rinex-cli -f test_resources/OBS/V2/zegv0010.21o  \
    --retain-obs C1,L1
```

##Â Navigation Orbits

It is possible to retain Navigation Orbits of interest,
by using the retain-orb filter.

```bash
# list encountered "observables"
rinex-cli -f test_resources/NAV/V3/CBW100NLD_R_20210010000_01D_MN.rnx \
    retain-orb cus,omega0 --pretty
```

## Post processing

Some post processing operations are being developped. People usually perform them with tools like `rtklib`.
This application does not aim at matching what `rtklib` is capable of, but it can be a powerful and efficient
alternative to similarly supported operations

## 1D Differential RINEX

Differential RINEX is the operation rnx(a) - rnx(b) where both are Observation RINEX
assumed to be sampled by stationnary and close to each other different receivers.
This operation cancels atmospheric biases.

To perform such operation,
one must specify the Reference RINEX (`b` in the operation)
with `--diff`. For example:

```bash
rinex-cli \
    # set reference Observations (b)
    --diff test_resources/CRNX/V3/ESBC00DNK_R_20201770000_01D_30S_MO.crx.gz
    # set observation (a) to normalize to previous reference observations (b)
    # we perform the operation for each files that are provided by `-f`
    -f test_resources/CRNX/V3/MOJN00DNK_R_20201770000_01D_30S_MO.crx.gz
```

Obviously diff should come with valid Observations. 
The provided example files are ideal, as they share identical sampling conditions:
this is the ideal situation to perform such operation.

It is possible to perform post processing analysis on the resulting RINEX.
To do so, all known command arguments can be used. If user requests
a Record extraction (no particular operation) or visualization (`--plot`),
the program will exhibit the differenced phase data.

## 2D Differential RINEX

2D differential RINEX is the 1D differentiation between
two Observation RINEX files, and another differentiation,
across all vehicules spanning all epochs, where one vehicule is
selected as reference phase provider. To determine which
vehicule to select, the user must provide Navigation ephemeris,
along Observation references (like in 1D).

This operation cancels both
atmospheric and receiver clock induced biases.

To perform such operation,
one must specify the Reference context, which must comprise
Navigation ephemeris, and Reference Observations (`b` in the operation).
For example:

```bash
rinex-cli \
    # set reference context (obs,nav)
    --diff test_resources/CRNX/V3/ESBC00DNK_R_20201770000_01D_30S_MO.crx.gz,test_resources/NAV/V3/ESBC00DNK_R_20201770000_01D_MN.rnx.gz
    # pass observations (a) to differentiate against reference context (b)
    # we perform the operation for each file provided by -f
    -f test_resources/CRNX/V3/MOJN00DNK_R_20201770000_01D_30S_MO.crx.gz 
```

Reference context order in the description (obs,nav) does not matter:

```bash
rinex-cli \
    # set reference context (nav,obs)
    --diff test_resources/NAV/V3/ESBC00DNK_R_20201770000_01D_MN.rnx.gz,test_resources/CRNX/V3/ESBC00DNK_R_20201770000_01D_30S_MO.crx.gz
    # pass observations (a) to differentiate against reference context (b)
    # we perform the operation for each file provided by -f
    -f test_resources/CRNX/V3/MOJN00DNK_R_20201770000_01D_30S_MO.crx.gz 
```

The command line must be called once per Differentiation context (Obs+Nav).

It is possible to perform post processing analysis on the resulting data.
To do so, all known command arguments can be used. If user requests
a Record extraction (no particular operation) or visualization (`--plot`),
the program will exhibit the 2D differenced phase data.

## Cycle slips

Possible cycle slip events are described by the GNSS receiver.  
Print such information like this

```bash
rinex-cli --cycle-slips -f test_resources/OBS/V2/zegv0010.21o
```

Cycle slips determination is under development, by adding more data processing on top of the
previously defined Double Differential RINEX algorithm.

## RTK resolution

RTK resolution (rover/base) is under development, by combining the previous double differential RINEX post processing,
and adding a Navigation data analysis on top of it.

## Merge

Merge several RINEX together. We use the `teqc` identifiers to describe the merge operation

```bash
rinex-cli -m -f test_resources/OBS/V2/zegv0010.21o,test_resources/OBS/V2/delf0010.21o
```

This generates a new RINEX file "merged.rnx"

## `Split` special operation

It is possible to split given RINEX files into two.

`Split` has two behaviors

* (1) if given RINEX is a `merged` RINEX (either by `teqc` or this tool),
we split the record at the epoch (timestamps) where records were previously merged

* (2) otherwise, the user is expected to describe a timestamp (`epoch`) 
at which we will split the record.

### Splitting a previously merged record

```bash
# Merge two RINEX together
cargo run -f /tmp/file1.rnx,/tmp/file2.rnx -m --output /tmp/merged.rnx
# Split resulting RINEX
cargon run -f /tmp/merged.rnx --split --output /tmp/split1.rnx,/tmp/split2.rnx 
```

When splitting a merged RINEX, the header section is simply
copied into both results.

### Splitting record

If User provides an `epoch`, the tool will try to locate the
given timestamp and perform `split()` at this date & time.

Two description format are supported, for the user to describe a sampling
timestamp:

* "YYYY-MM-DD HH:MM:SS" : Datetime description and EpochFlag::Ok is assumed
* "YYYY-MM-DD HH:MM:SS X" : Datetime description where X describes the EpochFlag integer value.
Refer to RINEX standards for supported Epoch flag values 

The tool identifies matching timestamp by comparing the datetime field AND
the flag field. They both must match.

Example :

```bash
# Split a previously merged record
cargo run -f /tmp/merged.rnx --split \
    --output /tmp/file1.rnx,/tmp/file2.rnx

# Split a record at specified timestamp,
# don't forget the \" encapsulation \" ;)
cargo run -f /tmp/data.rnx --split "2022-06-03 16:00:00" \
    --output /tmp/file1.rnx,/tmp/file2.rnx

# Split a record at specified timestamp with precise Power Failure event
# don't forget the \" encapsulation \" ;)
cargo run -f /tmp/data.rnx --split "2022-06-03 16:00:00 1" \
    --output /tmp/file1.rnx,/tmp/file2.rnx
```

## ascii-plot

The ascii-plot emulates the quite interesting tiny plot that `teqc` attaches to its verbose report.

The ascii plot is currently generated for every given Observation RINEX file.

```bash
rinex-cli -f test_resources/OBS/V2/zegv0010.21o --ascii-plot

```

Like other requests, this one cancels the record exposure, with the previous command,
a single tiny plot is to be generated.

<img align="center" width="400" src="https://github.com/gwbres/rinex/blob/main/doc/ascii-plot.png">

To understand the meaning of this plot, please currently refer to the `teqc` documentation

## Data visualization

It is possible to visualize data of interest, instead of raw "stdout" output.
To understand which RINEX record can currently be plotted, please
refer to the main README table.

Data visualization is requested with the `--plot` argument.  
Plots are generate in the form of PNG files currently.
The resulting visualization depends on the RINEX record being analyzed.
For example, for RINEX Observations, `--plot` will produce up to 4 files,
one per physics (observables), and possibly another one to 
represent receiver clock offsets, if such information was identified.

Previously mentionned filters can be stacked to the plotting operation,
to focus on data of interest. For instance, 
the following Carrier Phase and Signal Strength
visualization were generated with this command:

```bash
rinex-cli -f test_resources/OBS/V2/delf0010.21o \
    --retain-sv G11,R03,G13,G15 --retain-obs L1,S1 --plot
```

<img align="center" width="400" src="https://github.com/gwbres/rinex/blob/main/doc/phase.png">
<img align="center" width="400" src="https://github.com/gwbres/rinex/blob/main/doc/ssi.png">
